#!/usr/bin/env node

/*
 * git-move-branches - Fix up branches after git-branchless move
 *
 * After running `git move`, branches may remain pointing at old commits
 * instead of the newly-created equivalent commits. This command detects
 * that situation and relocates branches to the correct commits.
 *
 * Detection algorithm:
 * 1. Look at all commits in stack() for duplicate commit messages
 * 2. For each duplicate pair, compare committer timestamps
 * 3. If the branch is on the older commit, move it to the newer one
 * 4. If the branch is already on the newer commit, do nothing
 * 5. Preserve remote tracking info
 */

const { execSync } = require('child_process')

function run(cmd, options = {}) {
  try {
    return execSync(cmd, { encoding: 'utf8', ...options }).trim()
  } catch (e) {
    if (options.allowFailure) return null
    throw e
  }
}

function getStackCommits() {
  // Get all commits in the stack with their messages
  // Format: "shorthash message"
  const output = run("git query 'stack()'")
  if (!output) return []

  const commits = []
  for (const line of output.split('\n')) {
    if (!line.trim()) continue
    const spaceIdx = line.indexOf(' ')
    if (spaceIdx === -1) continue

    const shortHash = line.slice(0, spaceIdx)
    const message = line.slice(spaceIdx + 1)
    // Expand to full hash for consistent comparison
    const hash = run(`git rev-parse ${shortHash}`)
    commits.push({ hash, message })
  }
  return commits
}

function getBranchesInStack() {
  // Get all branch names in the stack
  const output = run("git query -b 'stack()'", { allowFailure: true })
  if (!output) return new Map()

  const branches = new Map()
  for (const line of output.split('\n')) {
    const branch = line.trim()
    if (!branch) continue

    const hash = run(`git rev-parse ${branch}`)
    const remote = run(`git config branch.${branch}.remote`, { allowFailure: true })
    const merge = run(`git config branch.${branch}.merge`, { allowFailure: true })

    branches.set(hash, { branch, remote, merge })
  }
  return branches
}

function getCommitTimestamp(hash) {
  // Get committer timestamp (unix epoch)
  return parseInt(run(`git log -1 --format="%ct" ${hash}`), 10)
}

function findBranchesToMove(commits, branches) {
  // Group commits by message
  const byMessage = new Map()
  for (const commit of commits) {
    if (!byMessage.has(commit.message)) {
      byMessage.set(commit.message, [])
    }
    byMessage.get(commit.message).push(commit.hash)
  }

  // Find duplicates and move branch to the newer commit
  const toMove = []
  for (const [message, hashes] of byMessage) {
    if (hashes.length !== 2) continue

    const [hash1, hash2] = hashes

    // Determine which is newer by committer timestamp
    const time1 = getCommitTimestamp(hash1)
    const time2 = getCommitTimestamp(hash2)
    const [olderHash, newerHash] = time1 < time2 ? [hash1, hash2] : [hash2, hash1]

    // Find which commit has a branch (could be either one)
    const branchOnOlder = branches.get(olderHash)
    const branchOnNewer = branches.get(newerHash)

    if (branchOnOlder && !branchOnNewer) {
      // Branch is on older commit, move to newer
      toMove.push({
        branch: branchOnOlder.branch,
        from: olderHash,
        to: newerHash,
        remote: branchOnOlder.remote,
        merge: branchOnOlder.merge,
        message,
      })
    } else if (branchOnNewer && !branchOnOlder) {
      // Branch is already on newer commit, nothing to do
      // (This handles the case where the branch is already correct)
    }
    // If both or neither have branches, skip (unusual state)
  }

  return toMove
}

function main() {
  const args = process.argv.slice(2)
  const dryRun = args.includes('-n') || args.includes('--dry-run')

  if (args.includes('-h') || args.includes('--help')) {
    console.log(`Usage: git move-branches [options]

Fix up branches after git-branchless move.

After running 'git move', branches may remain pointing at old commits
instead of the newly-created equivalent commits. This command detects
duplicate commit messages in the stack and moves branches to the new commits.

Options:
  -n, --dry-run    Show what would be done without executing
  -h, --help       Show this help message

Example:
  git move -s 'stack()' -d main   # Run the move
  git move-branches               # Fix up the branches
`)
    process.exit(0)
  }

  console.log('Scanning stack for branches to relocate...')

  const commits = getStackCommits()
  const branches = getBranchesInStack()
  const toMove = findBranchesToMove(commits, branches)

  if (toMove.length === 0) {
    console.log('No branches need to be relocated.')
    process.exit(0)
  }

  console.log(`Found ${toMove.length} branch(es) to relocate:`)
  for (const m of toMove) {
    const tracking = m.remote ? ` (tracks ${m.remote}/${m.merge?.replace('refs/heads/', '')})` : ''
    console.log(`  ${m.branch}: ${m.from.slice(0, 7)} -> ${m.to.slice(0, 7)}${tracking}`)
    console.log(`    "${m.message}"`)
  }

  if (dryRun) {
    console.log('\n(dry-run mode, no changes made)')
    process.exit(0)
  }

  console.log('\nRelocating branches...')
  for (const m of toMove) {
    // Delete old branch and create at new location
    run(`git branch -D ${m.branch}`)
    run(`git branch ${m.branch} ${m.to}`)

    // Restore tracking info if it existed
    if (m.remote) {
      run(`git config branch.${m.branch}.remote ${m.remote}`)
    }
    if (m.merge) {
      run(`git config branch.${m.branch}.merge ${m.merge}`)
    }

    console.log(`  âœ“ ${m.branch}`)
  }

  console.log('\nDone!')
}

main()
